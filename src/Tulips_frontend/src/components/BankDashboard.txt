import React, { useEffect, useState } from "react";
import "../main.css";

export default function BankDashboard({ principal, getBalance, transfer, payout }) {
  const [balance, setBalance] = useState("0");
  const [dest, setDest] = useState("");
  const [amt, setAmt] = useState("");
  const [msg, setMsg] = useState("");
  const [txLoading, setTxLoading] = useState(false);

  useEffect(() => { getBalance && getBalance().then(setBalance); }, [getBalance]);

  if (!principal || !getBalance) return (
    <div className="dashboard"><div className="skeleton" style={{ height: 140 }}/></div>
  );

  // Utility: Ellipsize principal for display
  function ellipsis(text, left=9, right=6) {
    if (!text || text.length <= left + right + 3) return text;
    return text.slice(0, left) + '...' + text.slice(-right);
  }

  return (
    <div className="dashboard">
      {/* Header */}
      <div className="dash-header" style={{ justifyContent: "space-between"}}>
        <h2 style={{display:"flex", alignItems:"center", gap:6, fontSize:"1.18em"}}>
          <span role="img" aria-label="bank">ğŸ¦</span> DAMN Bank
        </h2>
        <span className="chip chip-orange">Beta Demo</span>
      </div>

      {/* Account Card */}
      <div className="account-card" style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"1em"}}>
        <div>
          <div className="mono" style={{marginBottom:6,fontWeight:500, fontSize:"0.97em"}}>Principal:</div>
          <div className="mono" style={{fontSize: "0.88em",wordBreak:"break-all",color:"#333"}}>
            {ellipsis(principal)}
          </div>
        </div>
        <div>
          <div className="balance-big">{balance}</div>
          <div className="token">DAMN</div>
        </div>
      </div>

      {/* Payout */}
      <button
        className="btn btn-cta"
        style={{ width:"100%",marginBottom:18,marginTop:4 }}
        onClick={async () => {
          setMsg("Claiming initial payout...");
          setTxLoading(true);
          await payout();
          setMsg("Claimed! Refreshing balance...");
          setTimeout(() => { setTxLoading(false); setMsg(""); getBalance().then(setBalance); }, 1200);
        }}
        disabled={txLoading}
      >
        {txLoading ? <span className="spinner" style={{height:19,width:19}}/> : <span role="img" aria-label="gift">ğŸ</span>}
        <span style={{marginLeft:7}}>Claim 10,000 DAMN</span>
      </button>

      {/* Transfer */}
      <form className="transfer-form" autoComplete="off"
        onSubmit={async e => {
          e.preventDefault();
          setTxLoading(true);
          setMsg("Transferring...");
          await transfer(dest, amt);
          setMsg("Transferred! Refreshing balance...");
          setDest(""); setAmt("");
          setTimeout(() => { setTxLoading(false); setMsg(""); getBalance().then(setBalance); }, 1300);
        }}>
        <h4 style={{color:"#3955cf",marginBottom:"0.6em",display:"flex",alignItems:"center",gap:7}}>
          ğŸ” Transfer
        </h4>
        <input
          className="input"
          value={dest}
          onChange={e => setDest(e.target.value)}
          placeholder="Recipient Principal"
          required
          autoComplete="off"
        />
        <input
          className="input"
          value={amt}
          onChange={e => setAmt(e.target.value)}
          placeholder="Amount"
          type="number"
          min={1}
          required
          autoComplete="off"
        />
        <small style={{color:"#666",fontSize:"0.8em",display:"block",marginBottom:"0.3em"}}>
          âš ï¸ Note: A 3% fee will be charged on each transfer.
        </small>
        <button className="btn" style={{width:"100%",marginTop:"0.3em"}}>ğŸ“¤ Send</button>
      </form>

      {msg && <div className="notif" style={{marginTop:"1em",fontSize:"0.98em"}}>{msg}</div>}
    </div>
  );
}
